# Binance Futures Bot

바이낸스 USDT-M 선물 5분봉 기반 **횡보장 박스 단타** + **추세장 추세추종 단타** 전략입니다.

---

## 1. 전체 구조

- **장세 구분**: 15분봉 기준으로 시장을 **횡보장** / **추세장** / **중립** 세 가지로 나눕니다.
- **횡보장**: 박스권 조건 만족 → 박스 하단 근처 롱, 상단 근처 숏.
- **추세장**: MA20 기울기 ±2.5% 초과 → 상승/하락 추세에 따라 진입.
- **중립**: 위 조건 미충족 시 진입 안 함.
- **공통**: 5분봉이 닫힐 때마다 진입·청산 판단, 목표익절·손절·스탑로스로 청산.

### 페이퍼/라이브와 백테스트 정렬

- **진입·청산 시점**: 백테스트와 동일하게 **닫힌 5분봉의 종가**로만 판단.
- **새 봉 감지**: API에서 받은 OHLCV의 마지막 봉 시각이 이전 처리 시각보다 클 때 "새 봉"으로 간주. 그때 **방금 종료된 봉(전봉)** 의 종가로 익절/손절/전략 청산/진입 수행.
- **같은 봉 재진입**: 청산한 봉에서는 당 봉 내 재진입 없음 (백테스트의 `continue`와 동일).

---

## 2. 사용 데이터

| 용도           | 타임프레임 | 비고                    |
|----------------|------------|-------------------------|
| 장세 판별      | 15분봉     | 박스 여부, 추세 방향   |
| 추세 MA        | 15분봉     | MA7, MA20, MA50, MA100 |
| 진입/청산 체크 | 5분봉      | 종가, RSI(14)           |

---

## 3. 횡보장 전략 (Sideways)

### 3.1 횡보장 판별 (15분봉)

- 최근 **REGIME_LOOKBACK_15M(96)** 개 15분봉 **고가/저가**로 박스권 판별.
- **박스 상단**: 구간 내 **고가** 최대인 봉 1개 + 그 봉과 **인덱스 2시간 이상** 떨어진 봉 중 **고가** 최대 1개 → 두 값 중 큰 값.
- **박스 하단**: 구간 내 **저가** 최소인 봉 1개 + 그 봉과 **인덱스 2시간 이상** 떨어진 봉 중 **저가** 최소 1개 → 두 값 중 작은 값.
- **기울기**: 상단 두 봉·하단 두 봉의 기울기(box_low 대비 봉당)가 각 **0.5% 이내**, 두 기울기 차이도 **0.5% 이내**. (가파르거나 비슷하지 않으면 박스 아님)
- **조건**: 박스 폭 1.5% 이상, 범위 절대값 ≥ 1, **현재가가 박스 내**. (상·하단 터치 횟수 조건 없음)

### 3.2 진입·청산

- **롱**: 가격이 박스 **하단 근처**(4% 이내). (MA 조건 없음)
- **숏**: 가격이 박스 **상단 근처**(4% 이내). (MA 조건 없음)
- 청산: 목표 익절, 손절, **박스 이탈**(상·하단 0.5% 돌파 시), 전략 신호(추세 전환).
- **장세 전환**: 가격이 박스권을 0.5% 돌파하면 **추세장**으로 간주하며, 다시 박스 안으로 들어올 때까지 횡보장 진입 없음.

---

## 4. 추세장 전략 (Trend)

### 4.1 추세장 판별 (15분봉)

- 최근 **96봉(24시간)** MA20 기울기 계산
- 기울기 = `(마지막 MA20 - 첫 번째 MA20) / 첫 번째 MA20 × 100`
- **상승장**: 기울기 > +2.5%
- **하락장**: 기울기 < -2.5%

### 4.2 진입 조건

**상승장:**
- **롱**: `가격 ≤ MA20` + `RSI ≤ 48`
- **숏**: `가격 ≥ MA20` + `RSI ≥ 80`

**하락장:**
- **롱**: `가격 ≤ MA20` + `RSI ≤ 20`
- **숏**: `가격 ≥ MA20` + `RSI ≥ 52`

### 4.3 청산 조건

- **익절**: 수익률 ≥ 5.5%
- **손절**: 수익률 ≤ -2.5%
- **스탑로스**: 가격 기준 손실률 2.5% 도달 시

---

## 5. 펀딩비 (Funding Rate)

바이낸스 USDT-M 선물은 **00:00, 08:00, 16:00 UTC**에 8시간마다 펀딩이 정산됩니다.  
총 손익 = **매매 손익 + 펀딩 손익**으로 반영합니다.

| 모드 | 처리 방식 |
|------|-----------|
| **페이퍼** | 00/08/16 UTC에 포지션 보유 시 `funding.py`로 레이트 조회 후 잔고에 펀딩 손익 반영. `funding_log.csv`에 기록. |
| **백테스트** | `run_backtest(df, exchange=get_public_exchange())`로 실행 시 구간 펀딩 히스토리 조회 후 00/08/16 봉에서 잔고 반영. `exchange` 생략 시 펀딩 0. 결과에 `total_funding_pnl` 포함. |
| **라이브** | 거래소가 자동 정산하므로 **별도 계산 없음**. `fetch_balance()` 잔고에 이미 펀딩이 포함됨. |

- **funding.py**: 펀딩 레이트 조회(`fetch_current_funding_rate`, `fetch_funding_history`), 정산 구간 키·손익 계산.
- **paper_balance.json**: `balance`, `last_funding_utc_key`(마지막 펀딩 적용 구간) 저장.

---

## 6. 주요 파일

- **paper_trading.py** — 페이퍼 트레이딩 실행. 새 5분봉 시 전봉 종가로 진입·청산 (백테스트와 동일).
- **live_trader_agent.py** — 실거래 실행. 새 5분봉 시 전봉 종가로 진입·청산 (백테스트와 동일).
- **strategy_core_paper.py** / **strategy_core_live.py** — 장세 판별, 진입 신호, 진입/보유 사유 문자열  
- **exit_logic_paper.py** / **exit_logic_live.py** — 목표익절·손절·스탑로스·박스 이탈(상·하단 0.5% 돌파) 청산  
- **funding.py** — 펀딩 레이트 조회, 00/08/16 UTC 정산·손익 계산  
- **config_common.py** / **config_paper.py** / **config_live.py** — 공통·페이퍼·실거래 설정  
- **backtest.py** / **analyze_backtest.py** — 백테스트 및 장별 분석 (펀딩 옵션: `exchange` 인자)  
- **trade_logger.py** — 매매 기록 `trades_log.csv`, 펀딩 기록 `funding_log.csv` (meta 필드는 JSON 형식)  
- **daily_report.py** — 일일 매매 결과 리포트 이메일 전송 (`trades_log.csv` 기반, 전날 거래 내역 요약)  
- **data.py** — OHLCV 데이터 수집 및 장세 계산 (MA100 계산을 위해 충분한 데이터 확보 후 최근 24시간만 사용)  
