# Binance Futures Bot — 전략 설명

바이낸스 USDS-M 선물 5분봉 기반 **횡보장 박스 단타** + **추세장 추세추종 단타** 전략입니다.

---

## 1. 전체 구조

- **장세 구분**: 15분봉 기준으로 시장을 **횡보장** / **추세장** 두 가지로 나눕니다.
- **횡보장**: 박스권 조건을 만족 → 박스 하단 근처에서 롱, 상단 근처에서 숏.
- **추세장**: 박스가 아님 → 상승추세에서 MA 풀백 시 롱, 하락추세에서 MA 풀백 시 숏.
- **공통**: 5분봉이 하나 닫힐 때마다 진입·청산을 판단하며, 목표익절·손절·트레일링 스탑 등으로 청산합니다.

---

## 2. 사용 데이터

| 용도           | 타임프레임 | 비고                    |
|----------------|------------|-------------------------|
| 장세 판별      | 15분봉     | 박스 여부, 추세 방향   |
| 추세 MA        | 15분봉     | MA7, MA20, MA50, MA100 |
| 진입/청산 체크 | 5분봉      | 종가, RSI(14)           |

---

## 3. 횡보장 전략 (Sideways)

### 3.1 횡보장 판별 (15분봉)

- 최근 **REGIME_LOOKBACK_15M(96)** 개 15분봉으로 박스권을 냅니다.
- **박스 상·하단**: 해당 구간 고가 최댓값 = 상단, 저가 최솟값 = 하단.
- **조건**:
  - 박스 폭이 저가 대비 **SIDEWAYS_BOX_RANGE_PCT_MIN(1.5)%** 이상.
  - 현재가가 박스 안에 있음 (하단 ≤ 가격 ≤ 상단).
  - 상단·하단 각각 **SIDEWAYS_MIN_TOUCHES(2)** 회 이상 터치 (1.2% 이내 = 터치).
- 위를 모두 만족하면 **횡보장**, 하나라도 아니면 **추세장**으로 간주합니다.

### 3.2 진입 (포지션 없을 때)

- **롱**: MA7(15분) > MA20(15분) 이고, 가격이 박스 **하단 근처**(하단으로부터 4% 이내, `SIDEWAYS_BOX_BOTTOM_MARGIN`).
- **숏**: MA7(15분) < MA20(15분) 이고, 가격이 박스 **상단 근처**(상단으로부터 4% 이내, `SIDEWAYS_BOX_TOP_MARGIN`).

### 3.3 청산

- **전략 청산**: 롱은 가격이 박스 상단 근처까지 올라오면, 숏은 가격이 박스 하단 근처까지 내려가면 청산(flat).
- **목표 익절**: 수익률 ≥ **SIDEWAYS_PROFIT_TARGET(2.5)%** → 횡보 익절.
- **손절**: 수익률 ≤ **-SIDEWAYS_STOP_LOSS(2.0)%** 또는 가격 기준 **SIDEWAYS_STOP_LOSS_PRICE(2.0)%** 도달 → 손절/스탑로스.
- **박스 이탈**: 롱인데 가격이 박스 하단을 일정 마진(%) 이탈하면 하단이탈 청산, 숏인데 상단 이탈하면 상단이탈 청산.

---

## 4. 추세장 전략 (Trend / Neutral)

### 4.1 추세 정의 (15분봉 MA)

- **상승 추세**
  - MA7(15분) > MA20(15분).
  - **TREND_MA50_MA100_FILTER = True** 이면 MA50(15분) > MA100(15분) 도 필요.
- **하락 추세**
  - MA7(15분) < MA20(15분).
  - **TREND_MA50_MA100_FILTER = True** 이면 MA50(15분) < MA100(15분) 도 필요.

한쪽만 만족하면(예: MA7>MA20인데 MA50<MA100) 추세로 보지 않아 진입/청산 신호가 나오지 않습니다.

### 4.2 진입 (포지션 없을 때)

**롱**

1. 상승 추세.
2. 가격이 단기이평(MA7) 근처 풀백:  
   `현재가 ≤ MA7(15분) × (1 + TREND_PULLBACK_MA_PCT/100)`  
   (기본 **TREND_PULLBACK_MA_PCT = 1.0** → MA7 대비 1% 위까지 허용.)
3. RSI(5분봉) ≤ **TREND_RSI_LONG_MAX(58)** (과매수 방지).

**숏**

1. 하락 추세.
2. 가격이 단기이평(MA7) 근처 풀백:  
   `현재가 ≥ MA7(15분) × (1 - TREND_PULLBACK_MA_PCT/100)`  
   (기본 1% → MA7 대비 1% 아래까지 허용.)
3. RSI(5분봉) ≥ **TREND_RSI_SHORT_MIN(42)** (과매도 방지).

### 4.3 청산

**전략 신호 청산 (추세 반전)**

- **롱 보유**: 15분봉 기준 하락 추세로 전환(MA7 < MA20, 옵션 시 MA50 < MA100) → 즉시 flat.
- **숏 보유**: 15분봉 기준 상승 추세로 전환 → 즉시 flat.

**익절 / 손절 (exit_logic)**

| 구분       | 조건 | 청산 사유   |
|------------|------|-------------|
| 목표 익절  | 수익률 ≥ **5%** (레버리지 반영) | 추세 익절   |
| 손절       | 수익률 ≤ **-2.5%**              | 손절_추세   |
| 가격 스탑  | 롱: 가격 ≤ 진입가×(1 − 2.5%/레버) / 숏: 가격 ≥ 진입가×(1 + 2.5%/레버) | 스탑로스_추세 |

---

## 5. 설정 요약 (config.py)

### 공통

- **SYMBOL**: BTC/USDT  
- **TIMEFRAME**: 5m  
- **LEVERAGE**: 6  
- **POSITION_SIZE_PERCENT**: 0.25  
- **DAILY_LOSS_LIMIT_PCT**: 5.0 (일일 손실 한도)  
- **CONSECUTIVE_LOSS_LIMIT**: 4 (연속 손실 시 당일 진입 중단)

### 추세장

| 설정 | 기본값 | 의미 |
|------|--------|------|
| TREND_PROFIT_TARGET | 5.0 | 목표 익절 (%) |
| TREND_STOP_LOSS | 2.5 | 손절 (%) |
| TREND_STOP_LOSS_PRICE | 2.5 | 가격 기준 스탑 (%) |
| TREND_PULLBACK_MA_PCT | 1.0 | MA7 대비 풀백 허용 범위 (%) |
| TREND_RSI_LONG_MAX | 58 | 롱 진입 RSI 상한 |
| TREND_RSI_SHORT_MIN | 42 | 숏 진입 RSI 하한 |
| TREND_MA50_MA100_FILTER | True | 추세에 MA50 vs MA100 조건 사용 여부 |

### 횡보장

| 설정 | 기본값 | 의미 |
|------|--------|------|
| SIDEWAYS_PROFIT_TARGET | 2.5 | 목표 익절 (%) |
| SIDEWAYS_STOP_LOSS | 2.0 | 손절 (%) |
| SIDEWAYS_STOP_LOSS_PRICE | 2.0 | 가격 기준 스탑 (%) |
| SIDEWAYS_BOX_PERIOD | 48 | 박스 계산 기간 (15분봉) |
| SIDEWAYS_BOX_TOP_MARGIN | 0.04 | 상단 4% 이내 = 상단 근처 |
| SIDEWAYS_BOX_BOTTOM_MARGIN | 0.04 | 하단 4% 이내 = 하단 근처 |
| SIDEWAYS_BOX_RANGE_PCT_MIN | 1.5 | 박스 폭 최소 (%) |
| SIDEWAYS_MIN_TOUCHES | 2 | 상·하단 터치 최소 횟수 |

---

## 6. 실행

- **백테스트**: `python analyze_backtest.py` (또는 `run_and_analyze(days=365)` 등).
- **페이퍼 트레이딩**: `python paper_trading.py` (`.env`에 API 키 없이 퍼블릭 데이터만 사용 가능).
- **실거래**: `live_trader_agent.py` 등 (API 키 필요).

전략 로직은 `strategy_core.py`, 청산 조건은 `exit_logic.py`, 설정은 `config.py`에서 변경할 수 있습니다.
